import { serve } from "https://deno.land/std@0.224.0/http/server.ts";
import * as pdfjs from "https://esm.sh/pdfjs-dist@3.4.120/legacy/build/pdf.mjs";

try { 
  pdfjs.GlobalWorkerOptions.workerSrc = "https://esm.sh/pdfjs-dist@3.4.120/legacy/build/pdf.worker.mjs"; 
} catch {}

console.log("pdfjs-smoke: loaded esm.sh/pdfjs-dist@3.4.120/legacy");
console.log("workerSrc:", String(pdfjs.GlobalWorkerOptions.workerSrc));

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Minimal 1-page PDF (blank)
    const minimal = new Uint8Array([
      0x25,0x50,0x44,0x46,0x2d,0x31,0x2e,0x34,0x0a,0x25,0xe2,0xe3,0xcf,0xd3,0x0a,
      0x31,0x20,0x30,0x20,0x6f,0x62,0x6a,0x0a,0x3c,0x3c,0x20,0x2f,0x54,0x79,0x70,
      0x65,0x20,0x2f,0x43,0x61,0x74,0x61,0x6c,0x6f,0x67,0x20,0x2f,0x50,0x61,0x67,
      0x65,0x73,0x20,0x32,0x20,0x30,0x20,0x52,0x20,0x3e,0x3e,0x0a,0x65,0x6e,0x64,
      0x6f,0x62,0x6a,0x0a,0x32,0x20,0x30,0x20,0x6f,0x62,0x6a,0x0a,0x3c,0x3c,0x20,
      0x2f,0x54,0x79,0x70,0x65,0x20,0x2f,0x50,0x61,0x67,0x65,0x73,0x20,0x2f,0x4b,
      0x69,0x64,0x73,0x20,0x5b,0x20,0x33,0x20,0x30,0x20,0x52,0x20,0x5d,0x20,0x3e,
      0x3e,0x0a,0x65,0x6e,0x64,0x6f,0x62,0x6a,0x0a,0x33,0x20,0x30,0x20,0x6f,0x62,
      0x6a,0x0a,0x3c,0x3c,0x20,0x2f,0x54,0x79,0x70,0x65,0x20,0x2f,0x50,0x61,0x67,
      0x65,0x20,0x2f,0x50,0x61,0x72,0x65,0x6e,0x74,0x20,0x32,0x20,0x30,0x20,0x52,
      0x20,0x2f,0x4d,0x65,0x64,0x69,0x61,0x42,0x6f,0x78,0x20,0x5b,0x20,0x30,0x20,
      0x30,0x20,0x35,0x39,0x35,0x20,0x38,0x34,0x32,0x20,0x5d,0x20,0x3e,0x3e,0x0a,
      0x65,0x6e,0x64,0x6f,0x62,0x6a,0x0a,0x78,0x72,0x65,0x66,0x0a,0x30,0x20,0x33,
      0x0a,0x30,0x20,0x30,0x20,0x0a,0x74,0x72,0x61,0x69,0x6c,0x65,0x72,0x0a,0x3c,
      0x3c,0x20,0x2f,0x53,0x69,0x7a,0x65,0x20,0x31,0x20,0x2f,0x52,0x6f,0x6f,0x74,
      0x20,0x31,0x20,0x30,0x20,0x52,0x20,0x3e,0x3e,0x0a,0x73,0x74,0x61,0x72,0x74,
      0x78,0x72,0x65,0x66,0x0a,0x31,0x30,0x30,0x0a,0x25,0x25,0x45,0x4f,0x46,0x0a
    ]);
    
    let task = pdfjs.getDocument({ data: minimal, isEvalSupported: false, disableFontFace: true });
    try { 
      await (await task).promise; 
    } catch { 
      pdfjs.GlobalWorkerOptions.workerSrc = null as unknown as string; 
      task = pdfjs.getDocument({ data: minimal, isEvalSupported: false, disableFontFace: true }); 
    }
    
    const pdf = await task.promise;
    console.log("Smoke test success - Pages:", pdf.numPages, "| Worker:", String(pdfjs.GlobalWorkerOptions.workerSrc));
    
    return new Response(
      JSON.stringify({ ok: true, pages: pdf.numPages, message: "PDF.js is working correctly", workerSrc: String(pdfjs.GlobalWorkerOptions.workerSrc) }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (e) {
    return new Response(
      JSON.stringify({ ok: false, error: String(e) }), 
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
