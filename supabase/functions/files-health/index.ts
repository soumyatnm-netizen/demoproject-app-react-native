import { serve } from "https://deno.land/std@0.224.0/http/server.ts";

serve(async () => {
  const KEY = Deno.env.get("OPENAI_API_KEY");
  if (!KEY) return j(500, { ok: false, error: "missing OPENAI_API_KEY" });

  // Minimal 1-page PDF (blank)
  const bytes = new Uint8Array([
    0x25,0x50,0x44,0x46,0x2d,0x31,0x2e,0x34,0x0a,0x25,0xe2,0xe3,0xcf,0xd3,0x0a,
    0x31,0x20,0x30,0x20,0x6f,0x62,0x6a,0x0a,0x3c,0x3c,0x20,0x2f,0x54,0x79,0x70,
    0x65,0x20,0x2f,0x43,0x61,0x74,0x61,0x6c,0x6f,0x67,0x20,0x2f,0x50,0x61,0x67,
    0x65,0x73,0x20,0x32,0x20,0x30,0x20,0x52,0x20,0x3e,0x3e,0x0a,0x65,0x6e,0x64,
    0x6f,0x62,0x6a,0x0a,0x78,0x72,0x65,0x66,0x0a,0x30,0x20,0x31,0x0a,0x30,0x20,
    0x30,0x20,0x0a,0x74,0x72,0x61,0x69,0x6c,0x65,0x72,0x0a,0x3c,0x3c,0x20,0x2f,
    0x53,0x69,0x7a,0x65,0x20,0x31,0x20,0x2f,0x52,0x6f,0x6f,0x74,0x20,0x31,0x20,
    0x30,0x20,0x52,0x20,0x3e,0x3e,0x0a,0x73,0x74,0x61,0x72,0x74,0x78,0x72,0x65,
    0x66,0x0a,0x31,0x30,0x30,0x0a,0x25,0x25,0x45,0x4f,0x46,0x0a
  ]);
  
  // Use File instead of Blob (more robust in Edge/Deno)
  const file = new File([bytes], "tiny.pdf", { type: "application/pdf" });

  const form = new FormData();
  form.append("file", file);
  form.append("purpose", "assistants");

  const r = await fetch("https://api.openai.com/v1/files", {
    method: "POST",
    headers: { Authorization: `Bearer ${KEY}` },
    body: form
  });
  
  const t = await r.text();
  return j(r.ok ? 200 : r.status, { 
    ok: r.ok, 
    status: r.status, 
    body: t.slice(0, 400) 
  });
});

function j(status: number, body: unknown) {
  return new Response(JSON.stringify(body), {
    status,
    headers: { "Content-Type": "application/json" }
  });
}
